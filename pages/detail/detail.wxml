<view class="detail-page">
  <!-- 顶部导航栏 -->
  <van-nav-bar 
    title="工单详情" 
    left-arrow 
    bind:click-left="onBack"
    fixed 
    placeholder 
  />

  <!-- 返工提示条 -->
  <view class="rework-notice" wx:if="{{ order.status === 'rework' }}">
    <van-icon name="warning-o" size="18px" />
    <text>整改意见：{{ order.reworkReason }}</text>
  </view>

  <!-- 状态步骤条 -->
  <view class="steps-section card">
    <van-steps steps="{{ steps }}" active="{{ currentStep }}" />
  </view>

  <!-- 客户信息 -->
  <view class="info-section card">
    <view class="section-title">
      <van-icon name="user-o" size="18px" color="#1989fa" />
      <text>客户信息</text>
    </view>
    <view class="info-item">
      <text class="label">客户姓名</text>
      <text class="value">{{ order.customer.name }}</text>
    </view>
    <view class="info-item">
      <text class="label">联系电话</text>
      <text class="value phone" bind:tap="callPhone">{{ order.customer.phone }}</text>
    </view>
    <view class="info-item">
      <text class="label">客户地址</text>
      <text class="value">{{ order.customer.address }}</text>
    </view>
  </view>

  <!-- 安装要求 -->
  <view class="info-section card">
    <view class="section-title">
      <van-icon name="todo-list-o" size="18px" color="#1989fa" />
      <text>安装要求</text>
    </view>
    <view class="task-list">
      <view class="task-item" wx:for="{{ order.tasks }}" wx:key="index">
        <van-icon name="checked" size="16px" color="#07c160" />
        <text>{{ item }}</text>
      </view>
    </view>
  </view>

  <!-- 设备清单 -->
  <view class="info-section card">
    <view class="section-title">
      <van-icon name="orders-o" size="18px" color="#1989fa" />
      <text>设备清单</text>
    </view>
    <view class="equipment-list">
      <view class="equipment-item" wx:for="{{ order.equipment }}" wx:key="index">
        <view class="equipment-name">{{ item.name }}</view>
        <view class="equipment-detail">型号：{{ item.model }}</view>
        <view class="equipment-detail">SN：{{ item.sn }}</view>
      </view>
    </view>
  </view>

  <!-- 实施汇报表单（仅实施中状态显示） -->
  <view class="report-section card" wx:if="{{ order.status === 'implementing' }}">
    <view class="section-title">
      <van-icon name="edit" size="18px" color="#1989fa" />
      <text>实施汇报</text>
    </view>
    
    <van-field
      value="{{ remark }}"
      type="textarea"
      placeholder="请输入安装备注..."
      autosize="{{ { minHeight: 80 } }}"
      border="{{ false }}"
      bind:change="onRemarkChange"
    />

    <view class="upload-section">
      <view class="upload-title">上传照片（最多9张）</view>
      <van-uploader
        file-list="{{ photos }}"
        max-count="9"
        bind:after-read="onPhotoUpload"
        bind:delete="onPhotoDelete"
        bind:click-preview="onPhotoPreview"
      />
    </view>
  </view>

  <!-- 已完工照片展示 -->
  <view class="report-section card" wx:if="{{ order.status === 'completed' && order.photos.length > 0 }}">
    <view class="section-title">
      <van-icon name="photo-o" size="18px" color="#1989fa" />
      <text>完工照片</text>
    </view>
    <view class="completed-photos">
      <image 
        wx:for="{{ order.photos }}" 
        wx:key="index" 
        src="{{ item }}" 
        mode="aspectFill"
        class="photo-item"
        data-url="{{ item }}"
        bind:tap="previewCompletedPhoto"
      />
    </view>
    <view class="remark-display" wx:if="{{ order.remark }}">
      <text class="remark-label">安装备注：</text>
      <text>{{ order.remark }}</text>
    </view>
  </view>

  <!-- 底部占位 -->
  <view class="bottom-placeholder" wx:if="{{ showActionBar }}"></view>
</view>

<!-- 底部操作栏 -->
<view class="action-bar fixed-bottom safe-area-bottom" wx:if="{{ showActionBar }}">
  <van-button 
    wx:if="{{ order.status === 'pending' }}"
    type="warning" 
    block 
    round
    bind:click="handleAccept"
  >立即接单</van-button>
  
  <van-button 
    wx:if="{{ order.status === 'accepted' }}"
    type="primary" 
    block 
    round
    bind:click="handleStart"
  >开始实施</van-button>
  
  <van-button 
    wx:if="{{ order.status === 'implementing' }}"
    type="primary" 
    block 
    round
    bind:click="handleComplete"
  >确认完工</van-button>
  
  <van-button 
    wx:if="{{ order.status === 'rework' }}"
    type="danger" 
    block 
    round
    bind:click="handleRework"
  >处理返工</van-button>
</view>

<van-dialog id="van-dialog" />
<van-toast id="van-toast" />
