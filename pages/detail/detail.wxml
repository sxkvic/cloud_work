<view class="detail-container">
  <!-- 1. 状态条 -->
  <view class="status-banner {{ info.status === 'rework' ? 'is-rework' : '' }}">
    <view class="status-title">{{ statusText }}</view>
    <view class="status-tip">{{ statusTip }}</view>
  </view>

  <!-- 2. 驳回原因 -->
  <view wx:if="{{ info.status === 'rework' }}" class="reject-box">
    <text class="reject-label">驳回原因：</text>
    <text>{{ info.reworkReason || '照片不符合规范' }}</text>
  </view>

  <!-- 3. 客户信息 -->
  <view class="card">
    <view class="card-title">客户信息</view>
    <van-cell-group border="{{ false }}">
      <van-cell title="客户姓名" value="{{ info.customer.name }}" />
      <van-cell title="联系电话" value="{{ info.customer.phone }}" is-link bind:click="makeCall" />
      <van-cell title="安装地址" label="{{ info.customer.address }}" />
      <van-cell title="上门时间" value="{{ appointTime || info.appointmentTime || '未预约' }}" />
    </van-cell-group>
  </view>

  <!-- 4. 作业录入 (实施中/返工) -->
  <view class="card" wx:if="{{ info.status === 'implementing' || info.status === 'rework' }}">
    <view class="card-title">
      <text>作业回单</text>
      <van-tag type="primary" plain>必填</van-tag>
    </view>
    <van-cell-group border="{{ false }}">
      <van-field 
        value="{{ formAccount }}"
        label="宽带账号" 
        placeholder="请输入宽带账号" 
        required 
        bind:change="onAccountChange"
      />
      <van-field 
        value="{{ formSn }}"
        label="设备SN" 
        placeholder="扫码或输入" 
        required 
        use-button-slot
        bind:change="onSnChange"
      >
        <van-button slot="button" size="small" type="primary" bind:click="scanCode">扫码</van-button>
      </van-field>
      <van-field 
        value="{{ formPower }}"
        label="光衰(dBm)" 
        placeholder="-20.0" 
        type="digit" 
        bind:change="onPowerChange"
      />
    </van-cell-group>
    
    <view class="upload-area">
      <view class="upload-label">完工拍照 (设备/测速) 最多5张</view>
      <van-uploader 
        file-list="{{ fileList }}" 
        bind:after-read="afterRead" 
        bind:delete="onPhotoDelete"
        max-count="5" 
      />
    </view>
  </view>

  <!-- 5. 已完工信息展示 -->
  <view class="card" wx:if="{{ info.status === 'completed' }}">
    <view class="card-title">
      <text>完工信息</text>
    </view>
    <van-cell-group border="{{ false }}">
      <van-cell title="宽带账号" value="{{ info.formAccount || '-' }}" />
      <van-cell title="设备SN" value="{{ info.formSn || '-' }}" />
    </van-cell-group>
    <view class="upload-area" wx:if="{{ info.photos && info.photos.length > 0 }}">
      <view class="upload-label">完工照片</view>
      <view class="photo-list">
        <image 
          wx:for="{{ info.photos }}" 
          wx:key="index" 
          src="{{ item }}" 
          mode="aspectFill" 
          class="photo-item"
        />
      </view>
    </view>
  </view>

  <!-- 底部占位 -->
  <view style="height: 140rpx;"></view>

  <!-- 6. 底部固定操作栏 -->
  <view class="bottom-bar">
    <!-- 待接单 -->
    <van-button 
      wx:if="{{ info.status === 'pending' }}" 
      block 
      type="info" 
      color="#1989fa" 
      bind:click="doAccept"
    >确认接单</van-button>
    
    <!-- 接单中 -> 预约 -->
    <van-button 
      wx:if="{{ info.status === 'accepted' }}" 
      block 
      type="info" 
      color="#1989fa" 
      bind:click="showPopup"
    >预约上门时间</van-button>
    
    <!-- 实施中/返工 -> 提交 -->
    <van-button 
      wx:if="{{ info.status === 'implementing' || info.status === 'rework' }}" 
      block 
      type="info" 
      color="#1989fa" 
      bind:click="doSubmit"
    >{{ info.status === 'rework' ? '修正完毕，重新提交' : '施工完成，提交审核' }}</van-button>
    
    <!-- 已完工 -->
    <van-button 
      wx:if="{{ info.status === 'completed' }}" 
      block 
      disabled 
      color="#07c160"
    >工单已归档</van-button>
  </view>

  <!-- 时间选择器 Popup -->
  <van-popup show="{{ showPicker }}" position="bottom" bind:close="onClosePopup" round>
    <van-datetime-picker
      type="datetime"
      value="{{ currentDate }}"
      min-date="{{ minDate }}"
      bind:confirm="onConfirmDate"
      bind:cancel="onClosePopup"
    />
  </van-popup>

  <van-toast id="van-toast" />
  <van-dialog id="van-dialog" />
</view>
